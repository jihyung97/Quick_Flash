<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
>
<head>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct" crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="/css/style.css">

    <meta charset="UTF-8">
    <title>Title</title>
    <style>

        #image-section
        {
            height:200px;
        }
        .small-page{
            height:1000px;
            width:750px;
        }


    </style>

</head>
<body>
    <div class="small-page container" id="report-making"  th:data-exercise-type="${meetingPost.exerciseType}" th:data-postid="${meetingPost.postId}">
        <div class="w-75 join-list" >
            <div><h1>참여자list</h1></div>
            <div  class="w-75">
                <div class="d-flex justify-content-between meeting-join" th:each="meetingJoin : ${meetingPost.meetingJoinList}">
                    <div>
                        <span th:text="${meetingJoin.userName}"  >참가자</span>
                      </div>
                    <div class="d-flex justify-content-between">
                        <div class="ml-2">
                            <input type="radio"  th:value="COMPLETED_MEETING" th:name="${meetingJoin.userId}" th:data-userId="${meetingJoin.userId}" class="status-radio" /> 참여
                        </div>
                        <div class="ml-2">
                            <input type="radio"  th:value="ABANDONED_DURING_MEETING"th:name="${meetingJoin.userId}" th:data-userId="${meetingJoin.userId}" class="status-radio" /> 중간낙오
                        </div>
                        <div class="ml-2">
                            <input type="radio"  th:value="ABSENT_MEETING"th:name="${meetingJoin.userId}" th:data-userId="${meetingJoin.userId}" class="status-radio" /> 불참
                        </div>
                    </div>
                </div>
            </div>


        </div>
        <div class="justify-content-end"><button>전부참석</button> </div>
        <div class="mt-5">
            <div class="d-flex">
                <div>
                    <th:block th:if="${meetingPost.exerciseType} == RUNNING">
                        <div>
                            <label for="speed-running">페이스 (min/km):</label>
                            <input type="number" th:value="${meetingPost.speed}" id="speed-running" min="0" step="0.1" />

                        </div>

                    </th:block>

                    <th:block th:else>
                        <div>
                            <label for="speed-cycle">속도 (km/h):</label>
                            <input type="number" th:value="${meetingPost.speed}" id="speed-cycle" min="0" step="0.1" />
                        </div>

                        <div>
                            <label for="power">파워 (W):</label>
                            <input type="number" th:value="${meetingPost.power}" id="power" min="0" step="1" />
                        </div>
                    </th:block>

                    <div>
                        <label for="distance">총 거리 (km):</label>
                        <input type="number" th:value="${meetingPost.distance}" id="distance" min="0" step="0.1" />
                    </div>
                </div>
                <div class="ml-5 d-flex align-items-center" >
                   <button>strava 연동</button>
                </div>
                <div>
                    <span>모임 시각</span><span th:text="${meetingPost.expiredAt}"></span>
                    <div><input type="text" th:value="${meetingPost.location}" id="location"/></div>

                </div>
            </div>
            <div class="d-flex justify-content-start bg-warning mt-5" id="image-section">
                <div> <div class="h-100 w-100 bg-warning"></div></div>

            </div>
            <div class="ml-3 d-flex justify-content-end"><button> 사진 업롣,</button></div>
            <div>
                <div class="mt-5"><h2>운동 briefing</h2></div>
                <div>
                    <input type="text" width="200" id="afterMeetingContent">
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <button id="btn-submit">최종report보기</button>
                <button> 닫기</button>
            </div>
        </div>


    </div>
    <script>

        $(function(){
           $("#btn-submit").on("click", function () {
                let exerciseType = $("#report-making").data("exercise-type");

                let speed, power;

                if (exerciseType === "running") {
                    speed = $("#speed-running").val();
                    power = null;
                } else {
                    speed = $("#speed-cycle").val();
                    power = $("#power").val();
                }
                alert(speed);
                let distance = $("#distance").val();
                let afterMeetingContent = $("#afterMeetingContent").val();

              if (speed === "" || isNaN(Number(speed))) {
                    alert("속도를 다시 입력하세요");
                    return false;
                }
                speed = Number(speed);

                if (power !== null) {
                    if (power === "" || isNaN(Number(power))) {
                        alert("파워를 다시 입력하세요");
                        return false;
                    }
                    power = Number(power);
                }

                if (distance === "" || isNaN(Number(distance))) {
                    alert("거리를 다시 입력하세요");
                    return false;
                }
                distance = Number(distance);

                let radioList = document.querySelectorAll('.status-radio');
                let userIdToJoinStatus = {};

                radioList.forEach(radio => {
                    if (radio.checked) {
                        let userId = radio.getAttribute('data-userid'); 
                        userIdToJoinStatus[userId] = radio.value;
                    }
                });

                let postId = $("#report-making").data("postid");
                let location = $("#location").val();
                     
                 let formData = new FormData();
                    formData.append("exerciseType", exerciseType);
                    formData.append("speed", speed);
                    formData.append("distance", distance);
                    formData.append("afterMeetingContent", afterMeetingContent);
                    formData.append("postId", postId);
                    formData.append("location", location);

                    if (power !== null) {
                        formData.append("power", power);
                    }

                    //statusMap json화해서 저장한다
                   
                    console.log([...formData.entries()]);

                     
                    $.ajax({
                        url: "/meeting-post/update"  , 
                        type: "POST",
                        data: formData,
                        contentType: false, // FormData 사용 시 false
                        processData: false, // FormData 사용 시 false
                        success: function (data) {
                            alert("운동 리포트가 성공적으로 제출되었습니다.");
                            // 필요 시 페이지 이동 또는 폼 초기화
                        },
                        error: function (data) {
                            console.error(error);
                            alert("제출 중 오류가 발생했습니다.");
                        }
                    });

                      formData = new FormData();
                    formData.append("postId", postId);
                    formData.append("userIdToJoinStatus", JSON.stringify(userIdToJoinStatus));  // { "1": "approved", "2": "rejected" } 같은 형태

                    $.ajax({
                        url: "/meeting-join/update",
                        type: "POST",
                        data: formData,
                        contentType: false,
                        processData: false,
                        success: function (data) {
                            alert("참여자의 상태가 정상적으로 변경되었습니다.");
                        },
                        error: function (data) {
                            console.error(data);
                            alert("제출 중 오류가 발생했습니다.");
                        }
                    });
            });
    });
    </script>
</body>
 

 
</html>